---
import '../styles/global.scss';

// Components
import VoidEnergyUI from '../components/index.svelte';
import Modal from '../components/Modal.svelte';
import Toast from '../components/Toast.svelte';

// Configuration (SSOT)
import themeRegistry from '../config/void-registry.json';
import { VOID_TOKENS } from '../config/design-tokens';
---

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Void Energy UI</title>

    <script
      is:inline
      define:vars={{
        THEMES: themeRegistry,
        // We only need the factors (0.75, 1, 1.25) to drive the CSS calc() logic
        DENSITY_FACTORS: VOID_TOKENS.density.factors,
      }}
    >
      (function () {
        try {
          const root = document.documentElement;
          // 0. JS Ready Flag (Optional hooks for CSS)
          root.classList.remove('no-js');
          root.classList.add('js-active');

          const store = localStorage;

          // ================================================================
          // 1. RESTORE ATMOSPHERE (The Soul)
          // ================================================================
          const savedAtmosphere = store.getItem('void_atmosphere');

          // Validate: If saved theme exists in registry, use it. Else default to 'void'.
          const activeTheme =
            savedAtmosphere && THEMES[savedAtmosphere]
              ? savedAtmosphere
              : 'void';

          const config = THEMES[activeTheme];

          // Apply Triad Attributes (Instant Visual Sync)
          root.setAttribute('data-atmosphere', activeTheme);
          root.setAttribute('data-physics', config.physics);
          root.setAttribute('data-mode', config.mode);

          // ================================================================
          // 2. RESTORE USER CONFIG (The Body)
          // ================================================================
          const rawConfig = store.getItem('void_user_config');
          let userPrefs = {};

          if (rawConfig) {
            try {
              userPrefs = JSON.parse(rawConfig);
            } catch (e) {}
          }

          // A. Text Scale (Default: 1)
          const scale = userPrefs.scale || 1;
          // Clamp for safety (0.75 - 2.0) matching engine limits
          const safeScale = Math.min(Math.max(scale, 0.75), 2);
          root.style.setProperty('--text-scale', String(safeScale));

          // B. Custom Fonts
          if (userPrefs.fontBody) {
            root.style.setProperty('--user-font-body', userPrefs.fontBody);
          }
          if (userPrefs.fontHeading) {
            root.style.setProperty(
              '--user-font-heading',
              userPrefs.fontHeading
            );
          }

          // C. Density (The Math)
          // We apply the factor (e.g., 0.75) which CSS uses to calc() spacing
          const density = userPrefs.density || 'standard';
          const factor = DENSITY_FACTORS[density] || 1;
          root.style.setProperty('--density', String(factor));
        } catch (e) {
          console.warn('Void Engine: Hydration Failure', e);
          // Fail Safe: Default to Void/Glass/Dark
          document.documentElement.setAttribute('data-atmosphere', 'void');
          document.documentElement.setAttribute('data-physics', 'glass');
          document.documentElement.setAttribute('data-mode', 'dark');
        }
      })();
    </script>
  </head>
  <body>
    <VoidEnergyUI client:load />

    <Modal client:load />
    <Toast client:load />
  </body>
</html>
