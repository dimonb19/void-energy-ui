---
import '../styles/global.scss';

import VoidEnergyUI from '../components/index.svelte';
import Modal from '../components/Modal.svelte';
import Toast from '../components/Toast.svelte';

import themeRegistry from '../config/void-registry.json';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Void Energy UI</title>

    <script is:inline define:vars={{ THEMES: themeRegistry }}>
      (function () {
        try {
          const root = document.documentElement;
          const store = localStorage;

          // ----------------------------------------------------------------
          // 1. RESTORE ATMOSPHERE & PHYSICS (The Triad)
          // ----------------------------------------------------------------
          // Get the saved name (e.g., 'playground'), default to 'void'
          const savedAtmosphere = store.getItem('void_atmosphere') || 'void';

          // Check the injected THEMES object directly.
          // If 'playground' exists in JSON, we use it. If not, fallback to 'void'.
          const activeTheme = THEMES[savedAtmosphere]
            ? savedAtmosphere
            : 'void';
          const config = THEMES[activeTheme];

          // Apply the Triad attributes immediately
          root.setAttribute('data-atmosphere', activeTheme);
          root.setAttribute('data-physics', config.physics);
          root.setAttribute('data-mode', config.mode);

          // ----------------------------------------------------------------
          // 2. RESTORE USER CONFIG (Fonts & Scale)
          // ----------------------------------------------------------------
          const rawConfig = store.getItem('void_user_config');

          if (rawConfig) {
            const userPrefs = JSON.parse(rawConfig);

            // Restore Scale (Clamped for safety)
            if (userPrefs.scale) {
              const safeScale = Math.min(Math.max(userPrefs.scale, 0.75), 2);
              root.style.setProperty('--text-scale', safeScale);
            }

            // Restore Custom Fonts
            if (userPrefs.fontBody) {
              root.style.setProperty('--user-font-body', userPrefs.fontBody);
            }
            if (userPrefs.fontHeading) {
              root.style.setProperty(
                '--user-font-heading',
                userPrefs.fontHeading
              );
            }

            // Restore Density (Optional, prevents layout shift on high/low density)
            if (userPrefs.density && userPrefs.density !== 'standard') {
              // If you have DENSITY_MAPS available here, apply them.
              // Otherwise, the engine will catch up in a split second.
              // Usually, scale is the most important visual factor to restore instantly.
            }
          }
        } catch (e) {
          // Fail Safe: If JSON fails, force the default Void theme
          console.warn('Void Energy hydration failed:', e);
          document.documentElement.setAttribute('data-atmosphere', 'void');
          document.documentElement.setAttribute('data-physics', 'glass');
          document.documentElement.setAttribute('data-mode', 'dark');
        }
      })();
    </script>
  </head>
  <body>
    <VoidEnergyUI client:load />

    <Modal client:load />
    <Toast client:load />
  </body>
</html>
