<!-- ==========================================================================
  ðŸŒŒ VOID ENERGY: HYDRATION SCRIPT (Anti-FOUC)
  ==========================================================================
  
  PURPOSE:
  This critical script runs synchronously before the First Contentful Paint.
  It reads `localStorage` and applies the user's active Atmosphere, Font,
  and Scale immediately to the <html> root.

  WHY IS THIS NEEDED?
  Without this, the UI would render in the default 'void' theme for a split
  second before the JavaScript bundle loads, causing a jarring "Flash of 
  Unstyled Content" (FOUC) or "Flash of Wrong Theme".

  MECHANISM:
  1. Blocking Execution: `is:inline` ensures this runs immediately.
  2. DOM Manipulation: Sets `data-atmosphere` and CSS Variables.
  3. Handoff: Once loaded, `void-engine.ts` takes over state management.
  ========================================================================== -->

<script is:inline>
  // import THEMES from '../config/void-registry.json';

  (function () {
    try {
      const root = document.documentElement;
      const store = localStorage;

      // ----------------------------------------------------------------
      // 1. RESTORE ATMOSPHERE & PHYSICS (The Triad)
      // ----------------------------------------------------------------
      // Get the saved name (e.g., 'playground'), default to 'void'
      const savedAtmosphere = store.getItem('void_atmosphere') || 'void';

      // Check the injected THEMES object directly.
      // If 'playground' exists in JSON, we use it. If not, fallback to 'void'.
      const activeTheme = THEMES[savedAtmosphere] ? savedAtmosphere : 'void';
      const config = THEMES[activeTheme];

      // Apply the Triad attributes immediately
      root.setAttribute('data-atmosphere', activeTheme);
      root.setAttribute('data-physics', config.physics);
      root.setAttribute('data-mode', config.mode);

      // ----------------------------------------------------------------
      // 2. RESTORE USER CONFIG (Fonts & Scale)
      // ----------------------------------------------------------------
      const rawConfig = store.getItem('void_user_config');

      if (rawConfig) {
        const userPrefs = JSON.parse(rawConfig);

        // Restore Scale (Clamped for safety)
        if (userPrefs.scale) {
          const safeScale = Math.min(Math.max(userPrefs.scale, 0.75), 2);
          root.style.setProperty('--text-scale', safeScale);
        }

        // Restore Custom Fonts
        if (userPrefs.fontBody) {
          root.style.setProperty('--user-font-body', userPrefs.fontBody);
        }
        if (userPrefs.fontHeading) {
          root.style.setProperty('--user-font-heading', userPrefs.fontHeading);
        }

        // Restore Density (Optional, prevents layout shift on high/low density)
        if (userPrefs.density && userPrefs.density !== 'standard') {
          // If you have DENSITY_MAPS available here, apply them.
          // Otherwise, the engine will catch up in a split second.
          // Usually, scale is the most important visual factor to restore instantly.
        }
      }
    } catch (e) {
      // Fail Safe: If JSON fails, force the default Void theme
      console.warn('Void Energy hydration failed:', e);
      document.documentElement.setAttribute('data-atmosphere', 'void');
      document.documentElement.setAttribute('data-physics', 'glass');
      document.documentElement.setAttribute('data-mode', 'dark');
    }
  })();
</script>
