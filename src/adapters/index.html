<!-- ==========================================================================
  üåå VOID ENERGY: HYDRATION SCRIPT (Anti-FOUC)
  ==========================================================================
  
  PURPOSE:
  This critical script runs synchronously before the First Contentful Paint.
  It reads `localStorage` and applies the user's active Atmosphere, Font,
  and Scale immediately to the <html> root.

  WHY IS THIS NEEDED?
  Without this, the UI would render in the default 'void' theme for a split
  second before the JavaScript bundle loads, causing a jarring "Flash of 
  Unstyled Content" (FOUC) or "Flash of Wrong Theme".

  MECHANISM:
  1. Blocking Execution: `is:inline` ensures this runs immediately.
  2. DOM Manipulation: Sets `data-atmosphere` and CSS Variables.
  3. Handoff: Once loaded, `void-engine.ts` takes over state management.
  ========================================================================== -->

<script is:inline>
  // ‚ö†Ô∏è DATA DEPENDENCIES:
  // This script expects 'THEMES' and 'DENSITY_FACTORS' to be available globally
  // or injected by your build tool (e.g., Vite DefinePlugin / Astro define:vars).
  //
  // const THEMES = import('../config/void-registry.json');
  // const DENSITY_FACTORS = import('../config/design-tokens').VOID_TOKENS.density.factors;

  (function () {
    try {
      const root = document.documentElement;
      const store = localStorage;

      // 0. SIGNAL JS READY
      // Optional: Allows CSS to hide elements that require JS until ready
      root.classList.remove('no-js');
      root.classList.add('js-active');

      // ----------------------------------------------------------------
      // 1. RESTORE ATMOSPHERE & PHYSICS (The Soul)
      // ----------------------------------------------------------------
      const savedAtmosphere = store.getItem('void_atmosphere');

      // Safety Check: Ensure the registry exists
      const registry = typeof THEMES !== 'undefined' ? THEMES : {};

      // Validate: If saved theme exists in registry, use it. Else default to 'void'.
      const activeTheme =
        savedAtmosphere && registry[savedAtmosphere] ? savedAtmosphere : 'void';

      // Fallback config if registry is missing
      const config = registry[activeTheme] || {
        physics: 'glass',
        mode: 'dark',
      };

      // Apply Triad Attributes (Instant Visual Sync)
      root.setAttribute('data-atmosphere', activeTheme);
      root.setAttribute('data-physics', config.physics);
      root.setAttribute('data-mode', config.mode);

      // ----------------------------------------------------------------
      // 2. RESTORE USER CONFIG (The Body)
      // ----------------------------------------------------------------
      const rawConfig = store.getItem('void_user_config');

      if (rawConfig) {
        const userPrefs = JSON.parse(rawConfig);

        // A. Text Scale (Clamped 0.75x - 2.0x)
        if (userPrefs.scale) {
          const safeScale = Math.min(Math.max(userPrefs.scale, 0.75), 2);
          root.style.setProperty('--text-scale', String(safeScale));
        }

        // B. Custom Fonts
        if (userPrefs.fontBody) {
          root.style.setProperty('--user-font-body', userPrefs.fontBody);
        }
        if (userPrefs.fontHeading) {
          root.style.setProperty('--user-font-heading', userPrefs.fontHeading);
        }

        // C. Density (The Math)
        // We no longer calculate individual pixels. We just set the multiplier.
        // The CSS `_reset.scss` handles the calc() logic automatically.
        const density = userPrefs.density || 'standard';

        // Safety: Ensure DENSITY_FACTORS exists, otherwise default to 1
        const factors =
          typeof DENSITY_FACTORS !== 'undefined'
            ? DENSITY_FACTORS
            : { standard: 1 };
        const factor = factors[density] || 1;

        root.style.setProperty('--density', String(factor));
      }
    } catch (e) {
      // Fail Safe: If anything explodes, default to Void/Glass/Dark
      console.warn('Void Engine: Hydration Failure', e);
      document.documentElement.setAttribute('data-atmosphere', 'void');
      document.documentElement.setAttribute('data-physics', 'glass');
      document.documentElement.setAttribute('data-mode', 'dark');
    }
  })();
</script>
