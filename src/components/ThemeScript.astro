---
/*
  ROLE: Critical Rendering Path Script
  RESPONSIBILITY: 
  1. Blocks painting until the theme is calculated.
  2. Prevents FOUC (Flash of Unstyled Content).
  3. syncs with constants.ts to ensure LocalStorage keys match the Engine.
*/
import THEME_REGISTRY from '../config/void-registry.json';
import { STORAGE_KEYS, DOM_ATTRS, DEFAULTS } from '../config/constants';
---

<script
  is:inline
  define:vars={{
    registry: THEME_REGISTRY,
    keys: STORAGE_KEYS,
    attrs: DOM_ATTRS,
    defaults: DEFAULTS,
  }}
>
  (function () {
    try {
      var root = document.documentElement;

      // 1. READ STORAGE (Using the shared keys)
      var localAtmosphere = localStorage.getItem(keys.ATMOSPHERE);
      var localConfig = localStorage.getItem(keys.USER_CONFIG);

      // 2. VALIDATE ATMOSPHERE
      // Fallback to default if storage is empty or invalid (e.g. old theme name)
      var activeAtmosphere = defaults.ATMOSPHERE;

      if (localAtmosphere && registry[localAtmosphere]) {
        activeAtmosphere = localAtmosphere;
      }

      // 3. LOOKUP PHYSICS
      // This allows "retro" themes to load instant-motion CSS before the body paints.
      var themeData = registry[activeAtmosphere];

      // 4. INJECT ATTRIBUTES (The Triad)
      root.setAttribute(attrs.ATMOSPHERE, activeAtmosphere);
      root.setAttribute(attrs.PHYSICS, themeData.physics);
      root.setAttribute(attrs.MODE, themeData.mode);

      // 5. RESTORE USER PREFERENCES
      if (localConfig) {
        var config = JSON.parse(localConfig);

        // Scale
        if (config.scale) root.style.setProperty('--text-scale', config.scale);

        // Density (Map locally for speed/simplicity in blocking script)
        if (config.density) {
          var densities = { high: 0.75, standard: 1, low: 1.25 };
          root.style.setProperty('--density', densities[config.density] || 1);
        }

        // Fonts
        if (config.fontHeading)
          root.style.setProperty('--user-font-heading', config.fontHeading);
        if (config.fontBody)
          root.style.setProperty('--user-font-body', config.fontBody);
      }
    } catch (e) {
      console.warn('Void Hydration Error:', e);
      // Fail safely to defaults
      document.documentElement.setAttribute('data-atmosphere', 'void');
    }
  })();
</script>
